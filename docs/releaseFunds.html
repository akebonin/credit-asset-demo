<!DOCTYPE html>
<html>
<head>
  <title>Release Funds</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body style="font-family: sans-serif; padding: 2em; text-align: center;">
  <h2>Release Funds</h2>
  <p id="status">🔍 Checking MetaMask availability...</p>

  <script>
    async function main() {
      const statusEl = document.getElementById("status");

      if (typeof window.ethereum === 'undefined') {
        statusEl.textContent = "❌ MetaMask not available. Please open this page inside the MetaMask app.";
        return;
      }

      try {
        const params = new URLSearchParams(window.location.search);
        const yieldValue = parseInt(params.get("yield") || "0");
        const CONTRACT_ADDRESS = "0xfb3fc9218cb7c555b144f36390cde4c93aa8cbd6";

        const ABI = [{
          "inputs": [{"internalType": "uint256", "name": "actualYield", "type": "uint256"}],
          "name": "releaseFunds",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        }];

        statusEl.textContent = "🔗 Connecting to MetaMask...";
        await window.ethereum.request({ method: 'eth_requestAccounts' });

        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

        statusEl.textContent = "🚀 Sending transaction...";
        const tx = await contract.releaseFunds(yieldValue);
        statusEl.textContent = "✅ Transaction sent: " + tx.hash;
      } catch (err) {
        statusEl.textContent = "❌ Error: " + err.message;
      }
    }

    window.addEventListener('load', main);
  </script>
</body>
</html>
